<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Year 6 ä¸­è‹±æ–‡æº«æ›¸æ‡‰ç”¨ç¨‹å¼</title>
    <!-- å¼•å…¥ Tailwind CSS CDN ä»¥å¯¦ç¾éŸ¿æ‡‰å¼è¨­è¨ˆå’Œç¾è§€ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­ç½®å…¨å±€å­—é«”ç‚º Interï¼Œç¢ºä¿é–±è®€æ€§ */
        body { font-family: 'Inter', sans-serif; background-color: #f0f8ff; } 
        /* è‡ªè¨‚æ»¾å‹•æ¢æ¨£å¼ï¼Œè®“å®ƒæ›´æ´»æ½‘ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #E0F7FA; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 10px; }
        .card-shadow { box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        /* éš±è—åŸç”Ÿæ•¸å­—è¼¸å…¥çš„ç®­é ­ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        /* ç‚ºå–®å­—å¡æ·»åŠ  3D æ•ˆæœ */
        .flashcard {
            transition: transform 0.6s;
            transform-style: preserve-3d;
            height: 100%;
            width: 100%;
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            backface-visibility: hidden;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 1rem;
            padding: 1.5rem;
        }
        .flashcard-back {
            transform: rotateY(180deg);
        }
        .block-button {
            transition: all 0.2s;
            box-shadow: 0 4px #0056b3; /* è—è‰²æŒ‰éˆ•é™°å½± */
            margin-bottom: 4px; /* é˜²æ­¢é™°å½±è¢«é®æ“‹ */
        }
        .block-button:active {
            box-shadow: 0 1px #0056b3;
            transform: translateY(3px);
        }
        /* æ¨¡å¼ C ç©æœ¨ä½¿ç”¨ä¸åŒçš„é¡è‰²å’Œé™°å½± */
        .dictation-block {
            box-shadow: 0 4px #b45309; /* æ©˜è‰²æŒ‰éˆ•é™°å½± */
        }
        .dictation-block:active {
            box-shadow: 0 1px #b45309;
        }

    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold text-sky-700 mb-6 text-center">
            ğŸŒŸ Year 6 ä¸­è‹±æ–‡æº«æ›¸å°å¹«æ‰‹ ğŸŒŸ
        </h1>

        <!-- æ§åˆ¶é¢æ¿ï¼šèªéŸ³é¸æ“‡å’Œ Level é¸æ“‡ -->
        <div class="bg-white p-4 rounded-xl card-shadow mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0 md:space-x-4">
            
            <!-- èªéŸ³ç™¼éŸ³ç³»çµ± -->
            <div class="w-full md:w-1/2">
                <label for="voice-select" class="block text-sm font-medium text-gray-700 mb-1">ğŸ“¢ é¸æ“‡ç™¼éŸ³è€å¸« (å»ºè­°é¸ UK/US è‹±èª):</label>
                <select id="voice-select" class="w-full p-2 border border-sky-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 bg-sky-100 text-sky-800">
                    <option value="">æ­£åœ¨åŠ è¼‰èªéŸ³...</option>
                </select>
            </div>

            <!-- åˆ†çµ„å­¸ç¿’åŠŸèƒ½ (æ¨¡å¼ A å°ˆç”¨) -->
            <div class="w-full md:w-1/2">
                <label for="level-select" class="block text-sm font-medium text-gray-700 mb-1">ğŸ“š é¸æ“‡ç·´ç¿’çµ„åˆ¥ (Level):</label>
                <select id="level-select" class="w-full p-2 border border-yellow-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 bg-yellow-100 text-yellow-800" onchange="loadLevelData()">
                    <option value="all">å…¨éƒ¨å–®å­—</option>
                    <!-- Levels will be populated by JS -->
                </select>
            </div>
        </div>

        <!-- æ¨¡å¼åˆ‡æ› Tabs -->
        <div class="flex bg-gray-200 rounded-xl mb-6 p-1">
            <button id="tab-study" class="flex-1 py-3 text-lg font-bold rounded-lg transition-all" onclick="changeMode('study')">
                æ¨¡å¼ A (å­¸ç¿’å–®å­—)
            </button>
            <button id="tab-block" class="flex-1 py-3 text-lg font-bold rounded-lg transition-all" onclick="changeMode('block')">
                æ¨¡å¼ B (ä¸­æ–‡å¥å¼é‡çµ„)
            </button>
            <button id="tab-dictation" class="flex-1 py-3 text-lg font-bold rounded-lg transition-all" onclick="changeMode('dictation')">
                æ¨¡å¼ C (è‹±æ–‡è½å¯«é‡çµ„)
            </button>
        </div>

        <!-- å­¸ç¿’æ¨¡å¼ A (å–®å­—å¡) -->
        <div id="mode-study" class="hidden">
            <div class="h-[400px] bg-white rounded-xl card-shadow relative overflow-hidden p-6 md:p-10">
                <div id="flashcard-container" class="flashcard cursor-pointer" onclick="flipCard()">
                    <!-- æ­£é¢ï¼šä¸­æ–‡ -->
                    <div id="card-front" class="flashcard-face bg-sky-100 border-4 border-sky-500 text-center">
                        <p class="text-xl text-gray-500 font-semibold mb-2">ä¸­æ–‡ (é»æ“Šç¿»è½‰)</p>
                        <p id="card-cn-text" class="text-7xl font-black text-blue-700">é£¯å»³</p>
                        <p id="card-syllable-text" class="text-xl text-yellow-600 mt-4 hidden">fÃ n-tÄ«ng</p>
                    </div>
                    <!-- èƒŒé¢ï¼šä¸­è‹±è©èªå’Œç›¸å°ç…§ä¾‹å¥ (å·²æ›´æ–°) -->
                    <div id="card-back" class="flashcard-face bg-yellow-100 border-4 border-yellow-500 text-center justify-start py-8">
                        <p class="text-xl text-gray-500 font-semibold mb-1">è‹±æ–‡è©èª (English)</p>
                        <p id="card-en-text" class="text-5xl font-black text-red-700 mb-4">dining room</p>
                        
                        <p class="text-xl text-gray-500 font-semibold mb-1">ä¸­æ–‡è©èª (Chinese)</p>
                        <p id="card-cn-back-text" class="text-3xl font-bold text-blue-700 mb-6">é£¯å»³</p>
                        
                        <p class="text-sm font-semibold text-gray-700 mb-1 border-b border-yellow-400 w-full max-w-sm">å°ç…§ä¾‹å¥ (Corresponding Examples):</p>
                        <div class="space-y-3 w-full max-w-sm text-left px-4">
                            <p id="card-cn-example-text" class="text-lg text-gray-700 font-medium bg-yellow-200/50 p-2 rounded-lg">åª½åª½åœ¨é£¯å»³å–èŒ¶</p>
                            <p id="card-en-example-text" class="text-lg text-gray-800 italic bg-yellow-300/50 p-2 rounded-lg">Mum is having tea in the dining room.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å­¸ç¿’æ¨¡å¼ A æ§åˆ¶å€ -->
            <div class="mt-6 flex flex-wrap justify-center gap-3">
                <button class="flex-1 p-3 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition min-w-[120px] block-button" onclick="prevCard()">
                    <i class="fas fa-arrow-left"></i> ä¸Šä¸€å€‹
                </button>
                <button class="flex-1 p-3 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition min-w-[120px] block-button" onclick="speakCurrentWord()">
                    <i class="fas fa-volume-up"></i> è®€å‡ºè‹±æ–‡
                </button>
                <button class="flex-1 p-3 bg-indigo-500 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-600 transition min-w-[120px] block-button" onclick="toggleSyllable()">
                    é¡¯ç¤º/éš±è—éŸ³ç¯€
                </button>
                <button class="flex-1 p-3 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition min-w-[120px] block-button" onclick="nextCard()">
                    ä¸‹ä¸€å€‹ <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            <p id="study-progress" class="text-center mt-4 text-gray-600">é€²åº¦: 1 / 10</p>
        </div>

        <!-- å­¸ç¿’æ¨¡å¼ B (ç©æœ¨ - å¥å¼é‡çµ„) -->
        <div id="mode-block" class="hidden">
            <div class="bg-white p-6 md:p-8 rounded-xl card-shadow">
                <h2 class="text-2xl font-bold text-sky-700 mb-4">ğŸ  æ¨¡å¼ B: ä¸­æ–‡å¥å¼ç©æœ¨é‡çµ„ (Grammar)</h2>
                <div class="bg-yellow-100 p-4 rounded-lg mb-4 border-l-4 border-yellow-500">
                    <p class="text-sm font-semibold text-yellow-800">ğŸ¯ å¥å‹çµæ§‹:</p>
                    <p id="block-grammar-rule" class="text-base text-yellow-900 mt-1">S + åœ¨ + Location (è¡¨ç¤ºä½ç½®)</p>
                </div>
                
                <!-- å¾…ç¿»è­¯çš„è‹±æ–‡å¥å­ (ç”¨æ–¼åƒè€ƒ) -->
                <div class="text-center p-6 bg-sky-500 text-white rounded-lg mb-6">
                    <p id="block-en-sentence" class="text-3xl font-bold">Mum is having tea in dining room.</p>
                </div>

                <!-- ç­”æ¡ˆå€ -->
                <div class="p-4 bg-gray-100 rounded-lg min-h-[80px] mb-6 border-2 border-dashed border-gray-300">
                    <div id="block-answer-area" class="flex flex-wrap gap-2">
                        <!-- é‡çµ„å¾Œçš„ä¸­æ–‡ç©æœ¨å°‡æœƒæ”¾åœ¨é€™è£¡ -->
                    </div>
                </div>

                <!-- éš¨æ©Ÿç©æœ¨å€ -->
                <div class="p-4 bg-white rounded-lg border-2 border-sky-300">
                    <p class="text-sm font-medium text-gray-700 mb-2">é»æ“Šç©æœ¨ä¾†é‡çµ„ä¸­æ–‡å¥å­:</p>
                    <div id="block-scrambled-area" class="flex flex-wrap gap-2">
                        <!-- éš¨æ©Ÿç©æœ¨å°‡æœƒæ”¾åœ¨é€™è£¡ -->
                    </div>
                </div>

                <!-- ç©æœ¨æ¨¡å¼æ§åˆ¶æŒ‰éˆ• -->
                <div class="mt-6 flex flex-wrap justify-center gap-3">
                    <button class="p-3 bg-gray-400 text-white font-bold rounded-lg shadow-lg hover:bg-gray-500 transition block-button" onclick="resetBlockGame()">
                        é‡è¨­
                    </button>
                    <button class="p-3 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition block-button" onclick="checkBlockAnswer()">
                        æª¢æŸ¥ç­”æ¡ˆ
                    </button>
                    <button class="p-3 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition block-button" onclick="loadNextGrammar()">
                        ä¸‹ä¸€å€‹å¥å­
                    </button>
                </div>
                <p id="block-message" class="text-center mt-4 text-xl font-semibold min-h-[30px]"></p>
            </div>
        </div>

        <!-- å­¸ç¿’æ¨¡å¼ C (è½å¯« - è‹±æ–‡å¥å­é‡çµ„) -->
        <div id="mode-dictation" class="hidden">
            <div class="bg-white p-6 md:p-8 rounded-xl card-shadow">
                <h2 class="text-2xl font-bold text-yellow-700 mb-4">ğŸ§ æ¨¡å¼ C: è‹±æ–‡è½å¯«é‡çµ„ (10 é¡Œä¸€å›åˆ)</h2>

                <!-- é€²åº¦å’Œåˆ†æ•¸é¡¯ç¤º -->
                <div class="flex justify-between items-center mb-6 p-3 bg-indigo-100 rounded-lg border-2 border-indigo-400">
                    <p id="dictation-progress" class="text-lg font-semibold text-indigo-800">é€²åº¦: 1 / 10</p>
                    <p id="dictation-score-display" class="text-2xl font-black text-yellow-500">
                        åˆ†æ•¸: 0 / 10 â­
                    </p>
                </div>
                
                <!-- æç¤ºå€ (ä¸­æ–‡å¥å­) -->
                <div class="text-center p-6 bg-yellow-500 text-white rounded-lg mb-6">
                    <p class="text-xl font-semibold mb-2">ğŸ‘‚ è«‹ä»”ç´°è½è‹±æ–‡ç™¼éŸ³ï¼Œä¸¦æ ¹æ“šä¸­æ–‡æç¤ºé‡çµ„è‹±æ–‡å¥å­ï¼š</p>
                    <!-- é€™è£¡é¡¯ç¤ºä¸­æ–‡å¥å­ä½œç‚ºæç¤º -->
                    <p id="dictation-cn-word" class="text-3xl font-black">å¼Ÿå¼Ÿåœ¨å®¢å»³ç©é›»è…¦éŠæˆ²</p>
                    <button class="mt-4 p-3 bg-white text-yellow-600 font-bold rounded-full shadow-lg hover:bg-gray-100 transition block-button" onclick="speakCurrentDictation()">
                        <i class="fas fa-volume-up"></i> å†è½ä¸€æ¬¡è‹±æ–‡
                    </button>
                </div>

                <!-- ç­”æ¡ˆå€ -->
                <div class="p-4 bg-gray-100 rounded-lg min-h-[80px] mb-6 border-2 border-dashed border-gray-300">
                    <div id="dictation-answer-area" class="flex flex-wrap gap-2">
                        <!-- é‡çµ„å¾Œçš„è‹±æ–‡ç©æœ¨å°‡æœƒæ”¾åœ¨é€™è£¡ -->
                    </div>
                </div>

                <!-- éš¨æ©Ÿç©æœ¨å€ (è‹±æ–‡å–®å­—) -->
                <div class="p-4 bg-white rounded-lg border-2 border-yellow-300">
                    <p class="text-sm font-medium text-gray-700 mb-2">é»æ“Šç©æœ¨ä¾†é‡çµ„è‹±æ–‡å¥å­:</p>
                    <div id="dictation-scrambled-area" class="flex flex-wrap gap-2">
                        <!-- éš¨æ©Ÿè‹±æ–‡ç©æœ¨å°‡æœƒæ”¾åœ¨é€™è£¡ -->
                    </div>
                </div>

                <!-- è½å¯«æ¨¡å¼æ§åˆ¶æŒ‰éˆ• -->
                <div class="mt-6 flex flex-wrap justify-center gap-3">
                    <button class="p-3 bg-gray-400 text-white font-bold rounded-lg shadow-lg hover:bg-gray-500 transition block-button" onclick="resetDictationGame()">
                        é‡æ–°é–‹å§‹ 10 é¡Œ
                    </button>
                    <button id="dictation-check-button" class="p-3 bg-red-500 text-white font-bold rounded-lg shadow-lg hover:bg-red-600 transition block-button" onclick="checkDictationAnswer()">
                        æª¢æŸ¥ç­”æ¡ˆ
                    </button>
                    <button id="dictation-next-button" class="hidden p-3 bg-green-500 text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition block-button" onclick="loadNextDictation()">
                        ä¸‹ä¸€é¡Œ
                    </button>
                </div>
                <p id="dictation-message" class="text-center mt-4 text-xl font-semibold min-h-[30px]"></p>
            </div>
        </div>
    </div>

    <!-- Font Awesome Icons (ç”¨æ–¼éŸ³é‡åœ–æ¨™ç­‰) -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script>
        // === æ‡‰ç”¨ç¨‹å¼æ ¸å¿ƒè³‡æ–™ ===
        const vocabularyData = [
            // å–®å­—å­¸ç¿’æ¸…å–® (å·²æ›´æ–°çµæ§‹ï¼šæ–°å¢ en_example ä¸¦é‡å‘½å example ç‚º cn_example)
            { cn: "é£¯å»³", en: "dining room", cn_example: "åª½åª½åœ¨é£¯å»³å–èŒ¶", en_example: "Mum is having tea in the dining room.", syllable: "di-ning room" },
            { cn: "æ²™ç™¼", en: "sofa", cn_example: "å®¢å»³è£æœ‰æ²™ç™¼", en_example: "The living room has a sofa.", syllable: "so-fa" },
            { cn: "çª—", en: "window", cn_example: "è«‹æ‰“é–‹çª—", en_example: "Please open the window.", syllable: "win-dow" },
            { cn: "ç¡æˆ¿", en: "bedroom", cn_example: "å¼Ÿå¼Ÿåœ¨ç¡æˆ¿", en_example: "Younger brother is in the bedroom.", syllable: "bed-room" },
            { cn: "é›»è¦–æ©Ÿ", en: "television", cn_example: "å®¢å»³è£æœ‰é›»è¦–æ©Ÿ", en_example: "There is a television in the living room.", syllable: "tel-e-vi-sion" },
            { cn: "ç‡ˆ", en: "light", cn_example: "ç¡æˆ¿è£æœ‰ç‡ˆ", en_example: "There is a light in the bedroom.", syllable: "light" },
            { cn: "æ±", en: "east", cn_example: "æ±æ–¹æ—¥å‡º", en_example: "The sun rises in the east.", syllable: "east" },
            { cn: "å—", en: "south", cn_example: "é³¥å…’é£›å‘å—é‚Š", en_example: "The birds fly to the south.", syllable: "south" },
            { cn: "è¥¿", en: "west", cn_example: "è¥¿æ–¹æ—¥è½", en_example: "The sun sets in the west.", syllable: "west" },
            { cn: "åŒ—", en: "north", cn_example: "åŒ—æ–¹å¾ˆå†·", en_example: "It is cold in the north.", syllable: "north" },
            { cn: "å»šæˆ¿", en: "kitchen", cn_example: "çˆ¸çˆ¸åœ¨å»šæˆ¿æ´—ç¢—", en_example: "Dad is washing dishes in the kitchen.", syllable: "kitch-en" },
            { cn: "é›»è©±", en: "telephone", cn_example: "æ‰“é›»è©±çµ¦åª½åª½", en_example: "Call Mum on the telephone.", syllable: "tel-e-phone" },
            { cn: "æ›¸æ¶", en: "bookcase", cn_example: "æ›¸æˆ¿è£æœ‰æ›¸æ¶", en_example: "My study room has a bookcase.", syllable: "book-case" },
            { cn: "æµ´å®¤", en: "bathroom", cn_example: "æˆ‘åœ¨æµ´å®¤æ´—æ¾¡", en_example: "I am taking a bath in the bathroom.", syllable: "bath-room" },
            { cn: "èŒ¶å‡ ", en: "coffee table", cn_example: "èŒ¶å‡ ä¸Šæ”¾è‘—èŒ¶æ¯", en_example: "The cup is on the coffee table.", syllable: "co-ffee ta-ble" },
            { cn: "é›ªæ«ƒ", en: "fridge", cn_example: "é›ªæ«ƒè£æœ‰é£Ÿç‰©", en_example: "There is food in the fridge.", syllable: "fridge" },
            { cn: "å®¢å»³", en: "living room", cn_example: "å¼Ÿå¼Ÿåœ¨å®¢å»³ç©é›»è…¦éŠæˆ²", en_example: "Younger brother is playing computer games in the living room.", syllable: "li-ving room" },
            { cn: "å»æ‰€", en: "washroom", cn_example: "å“¥å“¥åœ¨å»æ‰€", en_example: "Elder brother is in the washroom.", syllable: "wash-room" },
            { cn: "é–€", en: "door", cn_example: "è«‹é—œé–€", en_example: "Please close the door.", syllable: "door" },
            { cn: "çƒ¤ç®±", en: "oven", cn_example: "çƒ¤ç®±è£çƒ¤è‘—éºµåŒ…", en_example: "The bread is baking in the oven.", syllable: "ov-en" },
            { cn: "é£Ÿç‰©", en: "food", cn_example: "é€™è£æœ‰ç¾å‘³çš„é£Ÿç‰©", en_example: "There is delicious food here.", syllable: "food" },
            { cn: "ä¸€æ—©", en: "early", cn_example: "æˆ‘ä¸€æ—©å°±èµ·åºŠ", en_example: "I wake up early in the morning.", syllable: "ear-ly" },
            { cn: "å°±", en: "then", cn_example: "ä¸€åšå®ŒåŠŸèª²å°±å»è¸¢çƒ", en_example: "After finishing homework, he then goes to play football.", syllable: "then" },
            { cn: "ä½ˆç½®", en: "decorate", cn_example: "ä½ˆç½®æˆ¿é–“", en_example: "Decorate the room.", syllable: "dec-o-rate" },
            { cn: "é–‹å§‹", en: "begin", cn_example: "é–‹å§‹ä¸Šèª²", en_example: "Begin the class.", syllable: "be-gin" },
            { cn: "ç´¯", en: "tired", cn_example: "æˆ‘å¾ˆç´¯äº†", en_example: "I am very tired.", syllable: "tired" },
        ];

        const grammarData = [
            // æ¨¡å¼ B & C (å¥å¼) - ç¬¬äºŒèª²çš„ 15 å€‹å¥å­
            // Rule 1: To indicate where you are, you use åœ¨.
            { rule: "S + åœ¨ + Location (è¡¨ç¤ºä½ç½®)", en: "Mum is in dining room", cn: "åª½åª½åœ¨é£¯å»³" },
            { rule: "S + åœ¨ + Location (è¡¨ç¤ºä½ç½®)", en: "Dad is in kitchen", cn: "çˆ¸çˆ¸åœ¨å»šæˆ¿" },
            { rule: "S + åœ¨ + Location (è¡¨ç¤ºä½ç½®)", en: "Elder brother is in toliet", cn: "å“¥å“¥åœ¨å»æ‰€" },
            { rule: "S + åœ¨ + Location (è¡¨ç¤ºä½ç½®)", en: "Younger brother is in bedroom", cn: "å¼Ÿå¼Ÿåœ¨ç¡æˆ¿" },
            // Rule 2: To indicate where you are and what you are doing there, you say the action after the location.
            { rule: "S + åœ¨ + Location + V/Action (è¡¨ç¤ºä½ç½®å’Œå‹•ä½œ)", en: "Mum is having tea in dining room", cn: "åª½åª½åœ¨é£¯å»³å–èŒ¶" },
            { rule: "S + åœ¨ + Location + V/Action (è¡¨ç¤ºä½ç½®å’Œå‹•ä½œ)", en: "Dad is washing dishes in kitchen", cn: "çˆ¸çˆ¸åœ¨å»šæˆ¿æ´—ç¢—" },
            { rule: "S + åœ¨ + Location + V/Action (è¡¨ç¤ºä½ç½®å’Œå‹•ä½œ)", en: "Elder brother is reading in bedroom", cn: "å“¥å“¥åœ¨ç¡æˆ¿çœ‹æ›¸" },
            { rule: "S + åœ¨ + Location + V/Action (è¡¨ç¤ºä½ç½®å’Œå‹•ä½œ)", en: "Younger brother is playing computer games in living room", cn: "å¼Ÿå¼Ÿåœ¨å®¢å»³ç©é›»è…¦éŠæˆ²" },
            // Rule 3: To describe what objects a particular room has, you add è£ after the room.
            { rule: "Location + è£ + æœ‰ + Objects (æè¿°æˆ¿é–“ç‰©å“)", en: "Living room has sofa, coffee table and television", cn: "å®¢å»³è£æœ‰æ²™ç™¼ã€èŒ¶å‡ å’Œé›»è¦–æ©Ÿ" },
            { rule: "Location + è£ + æœ‰ + Objects (æè¿°æˆ¿é–“ç‰©å“)", en: "My bedroom has bed, desk, bookshelf and wardrobe", cn: "æˆ‘çš„æ›¸æˆ¿è£æœ‰åºŠã€æ›¸æ¡Œã€æ›¸æ¶å’Œè¡£æ«ƒ" },
            // Rule 4: To indicate that something is done first in the morning, you say ä¸€æ—©å°±....
            { rule: "ä¸€æ—©å°±... (è¡¨ç¤ºæ—©ä¸Šåšçš„ç¬¬ä¸€ä»¶äº‹)", en: "I wake up early in the morning", cn: "æˆ‘ä¸€æ—©å°±èµ·åºŠ" },
            { rule: "ä¸€æ—©å°±... (è¡¨ç¤ºæ—©ä¸Šåšçš„ç¬¬ä¸€ä»¶äº‹)", en: "Younger sister does homework early in the morning", cn: "å¦¹å¦¹ä¸€æ—©å°±åšåŠŸèª²" },
            // Rule 5: To indicate that you do something immediately after you finish the previous action, you use ä¸€... å°±...
            { rule: "ä¸€... å°±... (è¡¨ç¤ºç·Šæ¥è‘—å®Œæˆçš„å‹•ä½œ)", en: "After åœ‹æ°‘ finishing his homework, he plays football", cn: "åœ‹æ°‘ä¸€åšå®ŒåŠŸèª²å°±å»è¸¢çƒ" },
            { rule: "ä¸€... å°±... (è¡¨ç¤ºç·Šæ¥è‘—å®Œæˆçš„å‹•ä½œ)", en: "After John having his dinner, he watches TV", cn: "John ä¸€åƒå®Œæ™šé£¯å°±çœ‹é›»è¦–" },
            { rule: "ä¸€... å°±... (è¡¨ç¤ºç·Šæ¥è‘—å®Œæˆçš„å‹•ä½œ)", en: "After we having dinner, we go ice skating", cn: "æˆ‘å€‘ä¸€åƒå®Œæ™šé¤å°±å»æºœå†°" }
        ];


        // === å…¨å±€ç‹€æ…‹ç®¡ç† ===
        let appState = {
            currentMode: 'study', // 'study', 'block', 'dictation'
            currentLevel: 'all',
            currentLevelData: [...vocabularyData], // ç•¶å‰ Level çš„å–®å­—è³‡æ–™
            currentCardIndex: 0,
            showSyllable: false,
            // èªéŸ³ç›¸é—œ
            voices: [],
            selectedVoice: null,
            // ç©æœ¨æ¨¡å¼ B ç›¸é—œ
            currentGrammarIndex: 0,
            blockAnswer: [],
            blockCorrectOrder: [],
            // è½å¯«æ¨¡å¼ C ç›¸é—œ (å·²æ›´æ–°)
            dictationScore: 0, 
            dictationQuestionCount: 10,
            currentDictationIndex: 0,
            currentDictationSet: [], // ç•¶å‰ 10 é¡Œçš„é›†åˆ
            dictationAnswer: [],
            dictationCorrectOrder: []
        };

        // === å·¥å…·å‡½æ•¸ ===

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // === èªéŸ³ç™¼éŸ³ç³»çµ± (TTS) ===
        const synth = window.speechSynthesis;
        const voiceSelect = document.getElementById('voice-select');

        function populateVoiceList() {
            appState.voices = synth.getVoices().sort((a, b) => a.name.localeCompare(b.name));
            voiceSelect.innerHTML = '<option value="">æ­£åœ¨åŠ è¼‰èªéŸ³...</option>'; // æ¸…ç©ºé¸é …
            
            // --- èª¿æ•´å¾Œçš„èªéŸ³é¸æ“‡é‚è¼¯ (å„ªå…ˆ UK è‹±èª) ---
            
            // 1. å„ªå…ˆå°‹æ‰¾ UK è‹±èª (en-GB)
            let defaultVoice = appState.voices.find(v => v.lang.includes('en-GB') || v.name.includes('Great Britain'));

            // 2. æœ€å¾Œï¼Œå›é€€åˆ° US è‹±èªæˆ–ä»»ä½•è‹±èªèªéŸ³
            if (!defaultVoice) {
                defaultVoice = appState.voices.find(v => v.lang.includes('en-US') || v.lang.startsWith('en'));
            }
            
            // ----------------------------------------------------

            appState.voices.forEach(voice => {
                // åªé¡¯ç¤ºè‹±èªèªéŸ³ï¼Œå› ç‚ºæ¨¡å¼ B å’Œ C éœ€è¦æ¨™æº–çš„è‹±èªç™¼éŸ³
                if (voice.lang.startsWith('en')) {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    option.value = voice.name;
                    option.setAttribute('data-lang', voice.lang);

                    if (voice === defaultVoice) {
                        option.selected = true;
                        appState.selectedVoice = voice;
                    }
                    voiceSelect.appendChild(option);
                }
            });

            // å¦‚æœ defaultVoice é‚„æ˜¯ null (æ¥µå°‘æ•¸æƒ…æ³)ï¼Œä½¿ç”¨ç¬¬ä¸€å€‹å¯ç”¨çš„èªéŸ³
            if (!appState.selectedVoice && appState.voices.length > 0) {
                appState.selectedVoice = appState.voices.find(v => v.lang.startsWith('en'));
                if (appState.selectedVoice) {
                    voiceSelect.value = appState.selectedVoice.name;
                }
            }

            voiceSelect.onchange = () => {
                const voiceName = voiceSelect.value;
                appState.selectedVoice = appState.voices.find(v => v.name === voiceName);
            };
        }

        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = populateVoiceList;
        } else {
            // å¦‚æœç€è¦½å™¨æ²’æœ‰ onvoiceschanged äº‹ä»¶ï¼Œç­‰å¾…ä¸€æ®µæ™‚é–“å†å˜—è©¦åŠ è¼‰
            setTimeout(populateVoiceList, 500);
        }

        function speakText(text) {
            if (!synth) return console.error('ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³åˆæˆ.');
            if (synth.speaking) {
                synth.cancel(); // åœæ­¢ç•¶å‰çš„èªéŸ³
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = appState.selectedVoice;
            
            // ç¢ºä¿ä½¿ç”¨è‹±èªç™¼éŸ³
            if (appState.selectedVoice) {
                utterance.lang = appState.selectedVoice.lang;
            } else {
                utterance.lang = 'en-US';
            }

            utterance.rate = 0.9; // ç¨å¾®æ…¢ä¸€é»ï¼Œæ–¹ä¾¿å­¸ç¿’

            synth.speak(utterance);
        }

        // === è³‡æ–™åˆ†çµ„èˆ‡ Level è¨­ç½® ===

        function setupLevels() {
            const numWords = vocabularyData.length;
            const levelCount = Math.ceil(numWords / 10);
            const levelSelect = document.getElementById('level-select');
            
            // æ¸…ç©ºèˆŠé¸é …ï¼Œä¿ç•™ "å…¨éƒ¨å–®å­—"
            levelSelect.innerHTML = '<option value="all">å…¨éƒ¨å–®å­—</option>';

            for (let i = 1; i <= levelCount; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `ç¬¬ ${i} çµ„ (å–®å­— ${((i - 1) * 10) + 1} - ${Math.min(i * 10, numWords)})`;
                levelSelect.appendChild(option);
            }
        }

        function loadLevelData() {
            appState.currentLevel = document.getElementById('level-select').value;
            appState.currentCardIndex = 0;

            if (appState.currentLevel === 'all') {
                appState.currentLevelData = [...vocabularyData];
            } else {
                const levelIndex = parseInt(appState.currentLevel) - 1;
                const start = levelIndex * 10;
                const end = start + 10;
                appState.currentLevelData = vocabularyData.slice(start, end);
            }

            // åªåœ¨æ¨¡å¼ A ä¸‹é‡æ–°æ¸²æŸ“
            if (appState.currentMode === 'study') {
                renderStudyCard();
            }
        }


        // === æ¨¡å¼åˆ‡æ›é‚è¼¯ ===
        function changeMode(mode) {
            appState.currentMode = mode;
            ['study', 'block', 'dictation'].forEach(m => {
                const tab = document.getElementById(`tab-${m}`);
                const content = document.getElementById(`mode-${m}`);
                
                if (m === mode) {
                    tab.classList.add('bg-sky-500', 'text-white');
                    tab.classList.remove('bg-gray-100', 'text-gray-700');
                    content.classList.remove('hidden');
                } else {
                    tab.classList.remove('bg-sky-500', 'text-white');
                    tab.classList.add('bg-gray-100', 'text-gray-700');
                    content.classList.add('hidden');
                }
            });

            // æ ¹æ“šæ¨¡å¼åˆå§‹åŒ–å…§å®¹
            if (mode === 'study') {
                loadLevelData(); // é‡æ–°è¼‰å…¥å–®å­—å¡è³‡æ–™
            } else if (mode === 'block') {
                loadNextGrammar(true); // åˆå§‹åŒ–ç©æœ¨æ¨¡å¼
            } else if (mode === 'dictation') {
                resetDictationGame(); // åˆå§‹åŒ–è½å¯«æ¨¡å¼
            }
        }

        // === æ¨¡å¼ A: å­¸ç¿’å–®å­—å¡ ===

        function renderStudyCard() {
            const data = appState.currentLevelData[appState.currentCardIndex];
            const cardContainer = document.getElementById('flashcard-container');
            
            if (!data) {
                document.getElementById('card-cn-text').textContent = "æœ¬çµ„åˆ¥ç„¡æ›´å¤šå–®å­—";
                document.getElementById('card-en-text').textContent = "No more words in this level";
                // ç”±æ–¼ UI æ”¹è®Šï¼Œéœ€è¦ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½è¢«è™•ç†
                document.getElementById('card-cn-back-text').textContent = "---";
                document.getElementById('card-cn-example-text').textContent = "---";
                document.getElementById('card-en-example-text').textContent = "---";
                document.getElementById('card-syllable-text').textContent = "";
                document.getElementById('study-progress').textContent = "é€²åº¦: 0 / 0";
                return;
            }

            // å–®å­—å¡å…§å®¹æ¸²æŸ“
            // æ­£é¢
            document.getElementById('card-cn-text').textContent = data.cn;
            
            // èƒŒé¢ (å·²æ›´æ–°)
            document.getElementById('card-cn-back-text').textContent = data.cn;
            document.getElementById('card-en-text').textContent = data.en;
            document.getElementById('card-cn-example-text').textContent = data.cn_example;
            document.getElementById('card-en-example-text').textContent = data.en_example;
            document.getElementById('card-syllable-text').textContent = data.syllable;
            
            // é¡¯ç¤ºæˆ–éš±è—éŸ³ç¯€
            if (appState.showSyllable) {
                document.getElementById('card-syllable-text').classList.remove('hidden');
            } else {
                document.getElementById('card-syllable-text').classList.add('hidden');
            }

            // æ›´æ–°é€²åº¦
            document.getElementById('study-progress').textContent = 
                `é€²åº¦: ${appState.currentCardIndex + 1} / ${appState.currentLevelData.length}`;

            // ç¢ºä¿å¡ç‰‡æ˜¯æ­£é¢æœä¸Š
            cardContainer.classList.remove('flipped');
        }

        function flipCard() {
            document.getElementById('flashcard-container').classList.toggle('flipped');
        }

        function prevCard() {
            appState.currentCardIndex = (appState.currentCardIndex - 1 + appState.currentLevelData.length) % appState.currentLevelData.length;
            renderStudyCard();
        }

        function nextCard() {
            appState.currentCardIndex = (appState.currentCardIndex + 1) % appState.currentLevelData.length;
            renderStudyCard();
        }

        function speakCurrentWord() {
            const data = appState.currentLevelData[appState.currentCardIndex];
            if (data) {
                speakText(data.en);
            }
        }
        
        function toggleSyllable() {
            appState.showSyllable = !appState.showSyllable;
            // ä¿æŒåœ¨ç•¶å‰å¡ç‰‡ï¼Œåªæ˜¯åˆ‡æ›éŸ³ç¯€é¡¯ç¤º
            if (appState.showSyllable) {
                document.getElementById('card-syllable-text').classList.remove('hidden');
            } else {
                document.getElementById('card-syllable-text').classList.add('hidden');
            }
        }


        // === æ¨¡å¼ B: ç©æœ¨ (ä¸­æ–‡å¥å¼é‡çµ„) ===
        
        function loadNextGrammar(reset = false) {
            if (reset) {
                appState.currentGrammarIndex = 0;
            } else {
                appState.currentGrammarIndex = (appState.currentGrammarIndex + 1) % grammarData.length;
            }

            const data = grammarData[appState.currentGrammarIndex];
            
            document.getElementById('block-grammar-rule').textContent = data.rule;
            document.getElementById('block-en-sentence').textContent = data.en;
            document.getElementById('block-message').textContent = '';

            // è¨­ç½®æ­£ç¢ºçš„é †åº (ä¸­æ–‡å¥å­ä»¥å­—ç‚ºå–®ä½æ‹†åˆ†)
            const cleanCN = data.cn.replace(/[ï¼Œã€‚ã€ï¼›ï¼šï¼ã€Œã€]/g, '');
            appState.blockCorrectOrder = cleanCN.split('').filter(s => s.trim().length > 0);
            
            const scrambledParts = shuffleArray([...appState.blockCorrectOrder]);

            appState.blockAnswer = [];
            renderBlockGame(scrambledParts);
        }

        function renderBlockGame(scrambledParts) {
            const answerArea = document.getElementById('block-answer-area');
            const scrambledArea = document.getElementById('block-scrambled-area');
            answerArea.innerHTML = '';
            scrambledArea.innerHTML = '';

            // æ¸²æŸ“ç­”æ¡ˆå€ç©æœ¨
            appState.blockAnswer.forEach((part, index) => {
                const btn = createBlockButton(part, 'answer', index);
                answerArea.appendChild(btn);
            });

            // æ¸²æŸ“éš¨æ©Ÿç©æœ¨å€
            scrambledParts.forEach((part, index) => {
                const btn = createBlockButton(part, 'scrambled', index);
                scrambledArea.appendChild(btn);
            });
        }

        function createBlockButton(text, type, index) {
            const btn = document.createElement('button');
            btn.textContent = text;
            btn.className = `block-button p-3 text-lg font-bold rounded-lg transition text-white ${type === 'answer' ? 'bg-indigo-500' : 'bg-sky-600 hover:bg-sky-700'}`;
            
            if (type === 'scrambled') {
                btn.onclick = (event) => moveBlockToAnswer(text, index, event.currentTarget);
            } else {
                btn.onclick = (event) => moveBlockToScrambled(text, index, event.currentTarget);
            }

            return btn;
        }

        /**
         * FIX: ç§»é™¤é‡è¤‡æ¸²æŸ“çš„é‚è¼¯ï¼Œç¾åœ¨åªä¾è³´ `renderBlockGame` é€²è¡Œå–®æ¬¡æ¸²æŸ“ã€‚
         */
        function moveBlockToAnswer(text, originalIndex, button) {
            appState.blockAnswer.push(text);
            
            // ç²å–ç›®å‰åœ¨ scrambled area ä¸­å‰©ä¸‹çš„ç©æœ¨ (æ’é™¤å‰›é»æ“Šçš„é‚£å€‹)
            const scrambledArea = document.getElementById('block-scrambled-area');
            const remainingScrambled = Array.from(scrambledArea.children)
                .filter(child => child !== button)
                .map(b => b.textContent);

            // åŸ·è¡Œå®Œæ•´çš„é‡æ–°æ¸²æŸ“
            renderBlockGame(remainingScrambled);
            
            document.getElementById('block-message').textContent = ''; // æ¸…é™¤æç¤º
        }

        /**
         * FIX: ç§»é™¤é‡è¤‡æ¸²æŸ“çš„é‚è¼¯ï¼Œç¾åœ¨åªä¾è³´ `renderBlockGame` é€²è¡Œå–®æ¬¡æ¸²æŸ“ã€‚
         */
        function moveBlockToScrambled(text, indexToRemove, button) {
            // å¾ç­”æ¡ˆå€ç§»é™¤
            appState.blockAnswer.splice(indexToRemove, 1);
            
            // ç²å–ç›®å‰åœ¨ scrambled area ä¸­å·²æœ‰çš„ç©æœ¨ï¼Œä¸¦åŠ ä¸Šå‰›ç§»å›çš„é‚£å€‹
            const currentScrambled = Array.from(document.getElementById('block-scrambled-area').children).map(b => b.textContent);
            currentScrambled.push(text);

            // åŸ·è¡Œå®Œæ•´çš„é‡æ–°æ¸²æŸ“
            renderBlockGame(currentScrambled);

            document.getElementById('block-message').textContent = ''; // æ¸…é™¤æç¤º
        }

        function resetBlockGame() {
            loadNextGrammar(true); // é‡æ–°è¼‰å…¥ç•¶å‰å¥å­
        }

        function checkBlockAnswer() {
            const userAnswer = appState.blockAnswer.join('');
            const correctAnswer = grammarData[appState.currentGrammarIndex].cn.replace(/[ï¼Œã€‚ã€ï¼›ï¼šï¼ã€Œã€]/g, ''); // ç§»é™¤æ¨™é»çš„æ­£ç¢ºç­”æ¡ˆ
            const messageEl = document.getElementById('block-message');

            if (userAnswer === correctAnswer) {
                messageEl.textContent = 'ğŸ‰ å¤ªæ£’äº†! ç­”æ¡ˆå®Œå…¨æ­£ç¢º!';
                messageEl.className = 'text-center mt-4 text-xl font-semibold text-green-600 min-h-[30px]';
                // æˆåŠŸå¾Œå¯ä»¥è‡ªå‹•åˆ‡æ›åˆ°ä¸‹ä¸€å€‹å¥å­
                setTimeout(() => loadNextGrammar(false), 1500);
            } else {
                messageEl.textContent = 'ğŸ˜¥ ä¸å°å–”ï¼Œå†è©¦è©¦çœ‹! æ­£ç¢ºç­”æ¡ˆæ˜¯: ' + grammarData[appState.currentGrammarIndex].cn;
                messageEl.className = 'text-center mt-4 text-xl font-semibold text-red-600 min-h-[30px]';
            }
        }

        // === æ¨¡å¼ C: è½å¯« (è‹±æ–‡å¥å­é‡çµ„) - ä½¿ç”¨ grammarData ===

        function updateDictationScoreDisplay() {
            const stars = 'â­'.repeat(appState.dictationScore);
            const remaining = 'âš«'.repeat(appState.dictationQuestionCount - appState.dictationScore);
            document.getElementById('dictation-score-display').innerHTML = 
                `åˆ†æ•¸: ${appState.dictationScore} / ${appState.dictationQuestionCount} ${stars}${remaining}`;
            document.getElementById('dictation-progress').textContent = 
                `é€²åº¦: ${appState.currentDictationIndex + 1} / ${appState.dictationQuestionCount}`;
        }
        
        function resetDictationGame() {
            // 1. é‡æ–°æ´—ç‰Œä¸¦è¨­å®š 10 é¡Œ (ä½¿ç”¨ grammarData)
            const shuffled = shuffleArray([...grammarData]);
            // ç”±æ–¼ grammarData åªæœ‰ 15 å€‹å¥å­ï¼Œæˆ‘å€‘å–æœ€å¤š 10 å€‹
            appState.dictationQuestionCount = Math.min(10, grammarData.length); 
            appState.currentDictationSet = shuffled.slice(0, appState.dictationQuestionCount);
            
            // 2. é‡ç½®ç‹€æ…‹
            appState.currentDictationIndex = -1; // è¨­ç½®ç‚º -1ï¼Œè®“ loadNextDictation() å¾ 0 é–‹å§‹
            appState.dictationScore = 0;
            
            // 3. è¼‰å…¥ç¬¬ä¸€é“é¡Œ
            loadNextDictation();
        }

        function loadNextDictation() {
            appState.currentDictationIndex++; // ä¸‹ä¸€é¡Œ
            
            // æª¢æŸ¥æ˜¯å¦çµæŸå›åˆ
            if (appState.currentDictationIndex >= appState.dictationQuestionCount) {
                // çµæŸå›åˆ
                const finalStars = 'â­'.repeat(appState.dictationScore);
                document.getElementById('dictation-message').innerHTML = `
                    <div class="p-4 bg-green-100 rounded-lg">
                        <p class="text-3xl font-bold text-green-700">å›åˆçµæŸ!</p>
                        <p class="text-xl mt-2 text-green-800">æ‚¨ç²å¾—äº† ${appState.dictationScore} / ${appState.dictationQuestionCount} ç²’æ˜Ÿæ˜Ÿï¼</p>
                        <p class="text-5xl mt-4">${finalStars}</p>
                    </div>
                `;
                document.getElementById('dictation-check-button').classList.add('hidden');
                document.getElementById('dictation-next-button').classList.add('hidden');
                document.getElementById('dictation-progress').textContent = `å›åˆçµæŸ`;
                return;
            }

            const data = appState.currentDictationSet[appState.currentDictationIndex];
            
            // UI é‡è¨­
            // é¡¯ç¤ºä¸­æ–‡å¥å­ä½œç‚ºæç¤º
            document.getElementById('dictation-cn-word').textContent = data.cn; 
            document.getElementById('dictation-message').textContent = '';
            document.getElementById('dictation-check-button').classList.remove('hidden');
            document.getElementById('dictation-next-button').classList.add('hidden');
            document.getElementById('dictation-next-button').textContent = "ä¸‹ä¸€é¡Œ"; // é‡è¨­æŒ‰éˆ•æ–‡å­—

            // æ’­æ”¾è‹±æ–‡å¥å­éŸ³æª”
            speakText(data.en);

            // è¨­ç½®æ­£ç¢ºçš„è‹±æ–‡å–®å­—é †åº (å»é™¤è‹±æ–‡å¥å­çš„æ¨™é»ç¬¦è™Ÿï¼Œä¸¦ä»¥ç©ºæ ¼åˆ†éš”)
            const cleanEN = data.en.replace(/[.,!?;:]/g, ''); 
            const correctWords = cleanEN.split(' ').filter(word => word.length > 0);
            appState.dictationCorrectOrder = correctWords;
            
            // æ‰“äº‚è‹±æ–‡å–®å­—
            const scrambledWords = shuffleArray([...correctWords]);

            appState.dictationAnswer = [];
            renderDictationGame(scrambledWords);
            updateDictationScoreDisplay();
        }

        function renderDictationGame(scrambledWords) {
            const answerArea = document.getElementById('dictation-answer-area');
            const scrambledArea = document.getElementById('dictation-scrambled-area');
            answerArea.innerHTML = '';
            scrambledArea.innerHTML = '';

            // æ¸²æŸ“ç­”æ¡ˆå€ç©æœ¨ (ç´…è‰²ç©æœ¨)
            appState.dictationAnswer.forEach((part, index) => {
                const btn = createDictationBlock(part, 'answer', index);
                answerArea.appendChild(btn);
            });

            // æ¸²æŸ“éš¨æ©Ÿç©æœ¨å€ (é»ƒè‰²ç©æœ¨)
            scrambledWords.forEach((part, index) => {
                const btn = createDictationBlock(part, 'scrambled', index);
                scrambledArea.appendChild(btn);
            });
        }

        function createDictationBlock(text, type, index) {
            const btn = document.createElement('button');
            btn.textContent = text;
            // æ¨¡å¼ C ä½¿ç”¨ç´…è‰² (ç­”æ¡ˆå€) å’Œ é»ƒè‰² (ç©æœ¨å€)
            btn.className = `block-button dictation-block p-3 text-lg font-bold rounded-lg transition ${type === 'answer' ? 'bg-red-500 text-white' : 'bg-yellow-600 text-white hover:bg-yellow-700'}`;
            
            if (type === 'scrambled') {
                btn.onclick = (event) => moveDictationBlockToAnswer(text, index, event.currentTarget);
            } else {
                btn.onclick = (event) => moveDictationBlockToScrambled(text, index, event.currentTarget);
            }

            return btn;
        }

        /**
         * FIX: ç§»é™¤é‡è¤‡æ¸²æŸ“çš„é‚è¼¯ï¼Œç¾åœ¨åªä¾è³´ `renderDictationGame` é€²è¡Œå–®æ¬¡æ¸²æŸ“ã€‚
         */
        function moveDictationBlockToAnswer(text, originalIndex, button) {
            // 1. æ›´æ–°å…§éƒ¨ç‹€æ…‹
            appState.dictationAnswer.push(text);

            // 2. ç²å–ç›®å‰åœ¨ scrambled area ä¸­å‰©ä¸‹çš„ç©æœ¨ (æ’é™¤å‰›é»æ“Šçš„é‚£å€‹)
            const scrambledArea = document.getElementById('dictation-scrambled-area');
            const remainingScrambled = Array.from(scrambledArea.children)
                .filter(child => child !== button)
                .map(b => b.textContent);
            
            // 3. åŸ·è¡Œå®Œæ•´çš„é‡æ–°æ¸²æŸ“
            renderDictationGame(remainingScrambled);
            
            document.getElementById('dictation-message').textContent = ''; 
        }

        /**
         * FIX: ç§»é™¤é‡è¤‡æ¸²æŸ“çš„é‚è¼¯ï¼Œç¾åœ¨åªä¾è³´ `renderDictationGame` é€²è¡Œå–®æ¬¡æ¸²æŸ“ã€‚
         */
        function moveDictationBlockToScrambled(text, indexToRemove, button) {
            // 1. å¾ç­”æ¡ˆå€ç§»é™¤
            appState.dictationAnswer.splice(indexToRemove, 1);
            
            // 2. ç²å–ç›®å‰åœ¨ scrambled area ä¸­å·²æœ‰çš„ç©æœ¨ï¼Œä¸¦åŠ ä¸Šå‰›ç§»å›çš„é‚£å€‹
            const currentScrambled = Array.from(document.getElementById('dictation-scrambled-area').children).map(b => b.textContent);
            currentScrambled.push(text);

            // 3. åŸ·è¡Œå®Œæ•´çš„é‡æ–°æ¸²æŸ“
            renderDictationGame(currentScrambled);
            
            document.getElementById('dictation-message').textContent = ''; 
        }

        function speakCurrentDictation() {
            const data = appState.currentDictationSet[appState.currentDictationIndex];
            if (data) {
                speakText(data.en); // æ’­æ”¾è‹±æ–‡å¥å­
            }
        }

        function checkDictationAnswer() {
            // ç­”æ¡ˆæª¢æŸ¥æ™‚å¿½ç•¥å¤§å°å¯«ï¼Œä¸¦å»é™¤æ‰€æœ‰æ¨™é»ç¬¦è™Ÿï¼Œåªæ¯”è¼ƒå–®å­—é †åº
            const userAnswer = appState.dictationAnswer.join(' ').toLowerCase();
            const correctAnswer = appState.dictationCorrectOrder.join(' ').toLowerCase();
            const messageEl = document.getElementById('dictation-message');

            if (userAnswer === correctAnswer) {
                // ç­”å°äº†
                appState.dictationScore++;
                messageEl.textContent = 'âœ¨ å®Œç¾! å¥å­é‡çµ„æ­£ç¢º! (+1 â­)';
                messageEl.className = 'text-center mt-4 text-xl font-semibold text-green-600 min-h-[30px]';
            } else {
                // ç­”éŒ¯äº†
                // ç”±æ–¼æ­£ç¢ºç­”æ¡ˆå·²ç¶“å„²å­˜åœ¨ appState.dictationCorrectOrder ä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
                messageEl.textContent = 'ğŸ¤” å·®ä¸€é»! æ­£ç¢ºç­”æ¡ˆæ˜¯: ' + appState.dictationCorrectOrder.join(' ');
                messageEl.className = 'text-center mt-4 text-xl font-semibold text-red-600 min-h-[30px]';
            }
            
            // éš±è—æª¢æŸ¥æŒ‰éˆ•ï¼Œé¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•
            document.getElementById('dictation-check-button').classList.add('hidden');
            if (appState.currentDictationIndex < appState.dictationQuestionCount - 1) {
                document.getElementById('dictation-next-button').classList.remove('hidden');
            } else {
                // æœ€å¾Œä¸€é¡Œï¼Œé¡¯ç¤ºä¸‹ä¸€é¡ŒæŒ‰éˆ•ä»¥çµæŸå›åˆ
                document.getElementById('dictation-next-button').classList.remove('hidden');
                document.getElementById('dictation-next-button').textContent = "æŸ¥çœ‹çµæœ";
            }
            updateDictationScoreDisplay();
        }


        // === æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ– ===
        function initializeApp() {
            setupLevels();
            loadLevelData(); // é è¨­è¼‰å…¥ Level 1 æˆ– All (ç”¨æ–¼ Mode A)
            changeMode('study'); // é è¨­é€²å…¥å­¸ç¿’æ¨¡å¼
            
            // ç¢ºä¿èªéŸ³åˆ—è¡¨åœ¨ç¶²é åŠ è¼‰å¾Œèƒ½è¢«å¡«å……
            if (synth.getVoices().length > 0) {
                populateVoiceList();
            }
        }
        
        // ç¢ºä¿æ‰€æœ‰ DOM å…ƒç´ åŠ è¼‰å®Œæˆå¾Œå†åŸ·è¡Œåˆå§‹åŒ–
        window.onload = initializeApp;
    </script>
</body>
</html>
